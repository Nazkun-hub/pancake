---
description: 
globs: 
alwaysApply: false
---
# PancakeSwap V3 æµåŠ¨æ€§ç®¡ç†ç³»ç»Ÿ - æ¶æ„è§„èŒƒ (é‡æ„ç‰ˆ)

## ğŸ—ï¸ æ–°æ¶æ„æ¦‚è¿°

æœ¬ç³»ç»Ÿç»è¿‡**é‡å¤§é‡æ„**ï¼Œä»å•ä¸€åºå¤§æœåŠ¡è½¬å˜ä¸º**ä¸“ç”¨æ¨¡å—åŒ–æ¶æ„**ï¼Œä¸¥æ ¼åˆ†ç¦»èŒè´£ï¼Œç¡®ä¿ä»£ç æ¸…æ™°ã€å¯ç»´æŠ¤ã€å¯æ‰©å±•ã€‚

### æ ¸å¿ƒè®¾è®¡åŸåˆ™
- **èŒè´£åˆ†ç¦»**ï¼šæ¯ä¸ªæœåŠ¡ä¸“æ³¨å•ä¸€æ ¸å¿ƒåŠŸèƒ½
- **åŠŸèƒ½å¤ç°**ï¼š100%å¤ç°å‚è€ƒè„šæœ¬çš„æ‰€æœ‰é€»è¾‘å’Œæ­¥éª¤
- **æ¶æ„æ¸…æ™°**ï¼šæ¨¡å—é—´ç•Œé™æ¸…æ™°ï¼Œä¸å…è®¸è·¨èŒè´£è°ƒç”¨
- **ä»£ç ç®€æ´**ï¼šå•ä¸€æ–‡ä»¶ä¸è¶…è¿‡800è¡Œï¼Œå•ä¸€æ–¹æ³•ä¸è¶…è¿‡100è¡Œ
- **ç”¨æˆ·å‹å¥½**ï¼šæ™ºèƒ½å‚æ•°è®¾è®¡ï¼Œç®€åŒ–ç”¨æˆ·è¾“å…¥

## ğŸ“ é‡æ„åç›®å½•ç»“æ„
```
src/
â”œâ”€â”€ api/                           # APIå±‚ï¼šHTTPæ¥å£
â”‚   â””â”€â”€ routes.ts                 # ç»Ÿä¸€è·¯ç”±ï¼Œè°ƒç”¨å„ä¸“ç”¨æœåŠ¡
â”œâ”€â”€ services/                     # ä¸šåŠ¡å±‚ï¼šä¸“ç”¨æœåŠ¡
â”‚   â”œâ”€â”€ LiquidityManager.ts      # ğŸ’§ æµåŠ¨æ€§æ·»åŠ ä¸“ç”¨æœåŠ¡
â”‚   â”œâ”€â”€ PositionManager.ts       # ğŸ¯ å¤´å¯¸ç®¡ç†ä¸“ç”¨æœåŠ¡  
â”‚   â”œâ”€â”€ ContractService.ts       # ğŸ”§ åŸºç¡€åˆçº¦äº¤äº’æœåŠ¡
â”‚   â”œâ”€â”€ Web3Service.ts           # ğŸŒ åŒºå—é“¾è¿æ¥æœåŠ¡
â”‚   â””â”€â”€ CryptoService.ts         # ğŸ” é’±åŒ…åŠ å¯†æœåŠ¡
â”œâ”€â”€ types/                        # ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ interfaces.ts            # ç»Ÿä¸€æ¥å£å®šä¹‰
â””â”€â”€ di/                          # ä¾èµ–æ³¨å…¥
    â””â”€â”€ container.ts             # DIå®¹å™¨é…ç½®
```

## ğŸ¯ æ–°ä¸‰å±‚ä¸“ç”¨æ¶æ„

### 1. APIå±‚ - [routes.ts](mdc:src/api/routes.ts)
**èŒè´£è¾¹ç•Œ**ï¼š
- âœ… HTTPè¯·æ±‚/å“åº”å¤„ç†
- âœ… å‚æ•°éªŒè¯å’Œæ ¼å¼åŒ–  
- âœ… è°ƒç”¨ä¸“ç”¨æœåŠ¡ï¼ˆLiquidityManagerã€PositionManagerï¼‰
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- âŒ ä¸šåŠ¡é€»è¾‘å®ç°
- âŒ ç›´æ¥åˆçº¦äº¤äº’
- âŒ å¤æ‚è®¡ç®—å¤„ç†

**è·¯ç”±åˆ†ç±»**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šè°ƒç”¨ä¸“ç”¨æœåŠ¡
router.post('/add-liquidity', async (req, res) => {
    // 1. å‚æ•°éªŒè¯
    const { inputAmount, inputToken, lowerPercent, upperPercent } = req.body;
    
    // 2. è°ƒç”¨ä¸“ç”¨LiquidityManager
    const liquidityManager = container.resolve<LiquidityManager>(TYPES.LiquidityManager);
    const result = await liquidityManager.createLiquidityPosition(params);
    
    // 3. æ ¼å¼åŒ–å“åº”
    res.json({ success: true, data: result });
});
```

### 2. ä¸“ç”¨æœåŠ¡å±‚

#### ğŸ’§ LiquidityManager - [LiquidityManager.ts](mdc:src/services/LiquidityManager.ts)
**å•ä¸€èŒè´£**ï¼šæµåŠ¨æ€§æ·»åŠ çš„å®Œæ•´å®ç°
**åŠŸèƒ½èŒƒå›´**ï¼š
- âœ… 100%å¤ç° `real_multicall_direct_test_fixed_v5.js` æ‰€æœ‰æ­¥éª¤
- âœ… å®æ—¶çŠ¶æ€è·å–å’Œé‡æ–°è®¡ç®— (`getRealTimeStateAndRecalculate`)
- âœ… åŠ¨æ€æ»‘ç‚¹è®¡ç®— (`calculateDynamicSlippage`)
- âœ… å®Œæ•´æ‰§è¡Œæµç¨‹ (`executeWithRealTimeRecalculation`)
- âœ… TickèŒƒå›´è®¡ç®— (`calculateTickRange`)
- âœ… æµåŠ¨æ€§æ•°é‡è®¡ç®— (`calculateLiquidityFromAmount`)
- âŒ å¤´å¯¸ç®¡ç†åŠŸèƒ½
- âŒ åŸºç¡€åˆçº¦æŸ¥è¯¢
- âŒ é’±åŒ…ç®¡ç†

**ä»£ç è§„èŒƒ**ï¼š
- æ–‡ä»¶å¤§å°ï¼š< 800è¡Œ
- æ–¹æ³•å¤§å°ï¼š< 100è¡Œ
- 100%åŠŸèƒ½å¤ç°ï¼Œä¸å…è®¸åˆ å‡æ­¥éª¤

```typescript
// âœ… æ­£ç¡®ï¼šä¸“æ³¨æµåŠ¨æ€§æ·»åŠ 
export class LiquidityManager implements IService {
    async createLiquidityPosition(params: AddLiquidityParams): Promise<Result> {
        // 1. è·å–æ± å­åœ°å€
        const poolAddress = await this.getPoolAddress(provider, POOL_CONFIG);
        
        // 2. å®æ—¶çŠ¶æ€è®¡ç®—ï¼ˆå¤ç°å‚è€ƒè„šæœ¬ï¼‰
        const state = await this.getRealTimeStateAndRecalculate(...);
        
        // 3. åŠ¨æ€æ»‘ç‚¹è®¡ç®—ï¼ˆå¤ç°å‚è€ƒè„šæœ¬ï¼‰
        const dynamicSlippage = this.calculateDynamicSlippage(...);
        
        // 4. æ‰§è¡Œäº¤æ˜“ï¼ˆå¤ç°å‚è€ƒè„šæœ¬ï¼‰
        return await this.executeWithRealTimeRecalculation(...);
    }
}
```

#### ğŸ¯ PositionManager - [PositionManager.ts](mdc:src/services/PositionManager.ts)
**å•ä¸€èŒè´£**ï¼šå¤´å¯¸ç®¡ç†çš„å®Œæ•´å®ç°
**åŠŸèƒ½èŒƒå›´**ï¼š
- âœ… 100%å¤ç° `position_management.js` æ‰€æœ‰åŠŸèƒ½
- âœ… è·å–ç”¨æˆ·å¤´å¯¸ (`getUserPositions`) - åŒ…å«å®Œæ•´ä»£å¸ä¿¡æ¯
- âœ… å…³é—­å•ä¸ªå¤´å¯¸ (`closeSinglePosition`) - Multicallä¸€æ­¥å®Œæˆ
- âœ… æ‰¹é‡å…³é—­æ‰€æœ‰å¤´å¯¸ (`closeAllPositions`) - è‡ªåŠ¨å¤„ç†æ‰€æœ‰ç±»å‹
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†
- âŒ æµåŠ¨æ€§æ·»åŠ åŠŸèƒ½
- âŒ åŸºç¡€åˆçº¦æŸ¥è¯¢  
- âŒ é’±åŒ…ç®¡ç†

**ç‰¹æ®Šè®¾è®¡**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨Multicallä¸€æ­¥å®Œæˆå¤´å¯¸å…³é—­
async closeSinglePosition(tokenId: string): Promise<PositionOperationResult> {
    const multicallData = [];
    
    // Step 1: ç§»é™¤æµåŠ¨æ€§ï¼ˆå¦‚æœæœ‰ï¼‰
    if (hasLiquidity) {
        const decreaseCalldata = positionManager.interface.encodeFunctionData('decreaseLiquidity', [params]);
        multicallData.push(decreaseCalldata);
    }
    
    // Step 2: æ”¶é›†æ‰‹ç»­è´¹å’Œå‰©ä½™ä»£å¸
    const collectCalldata = positionManager.interface.encodeFunctionData('collect', [params]);
    multicallData.push(collectCalldata);
    
    // Step 3: é”€æ¯NFT
    const burnCalldata = positionManager.interface.encodeFunctionData('burn', [tokenId]);
    multicallData.push(burnCalldata);
    
    // æ‰§è¡ŒMulticallï¼ˆä¸€æ¬¡äº¤æ˜“å®Œæˆæ‰€æœ‰æ“ä½œï¼‰
    const tx = await positionManager.multicall(multicallData);
}
```

#### ğŸ”§ ContractService - [ContractService.ts](mdc:src/services/ContractService.ts)
**ç²¾ç®€èŒè´£**ï¼šåŸºç¡€åˆçº¦äº¤äº’
**åŠŸèƒ½èŒƒå›´**ï¼š
- âœ… ä»£å¸æˆæƒ (`approveToken`)
- âœ… æ£€æŸ¥æˆæƒé¢åº¦ (`checkAllowance`)  
- âœ… è·å–æ± å­åœ°å€ (`getPoolAddress`)
- âœ… è·å–æ± å­çŠ¶æ€ (`getPoolState`)
- âœ… è·å–ä»£å¸ä¿¡æ¯ (`getTokenInfo`)
- âœ… Tickå·¥å…·æ–¹æ³• (`getTickSpacing`, `nearestUsableTick`)
- âŒ å¤æ‚æµåŠ¨æ€§é€»è¾‘ï¼ˆå·²è¿ç§»åˆ°LiquidityManagerï¼‰
- âŒ å¤´å¯¸ç®¡ç†é€»è¾‘ï¼ˆå·²è¿ç§»åˆ°PositionManagerï¼‰

### 3. åŸºç¡€è®¾æ–½å±‚
- **Web3Service** - åŒºå—é“¾è¿æ¥å’Œé’±åŒ…ç®¡ç†
- **CryptoService** - é’±åŒ…åŠ å¯†å’Œç§é’¥ç®¡ç†
- **EventBus** - äº‹ä»¶é€šä¿¡

## ğŸ”„ é‡æ„å¯¹æ¯”

### é‡æ„å‰é—®é¢˜
- âŒ ContractServiceè¿‡äºåºå¤§ï¼ˆ>2000è¡Œï¼‰
- âŒ æµåŠ¨æ€§é€»è¾‘ä¸å®Œæ•´ï¼Œç¼ºå°‘å…³é”®æ­¥éª¤
- âŒ å¤´å¯¸ç®¡ç†åŠŸèƒ½åˆ†æ•£ï¼Œç¼ºå°‘æ‰¹é‡æ“ä½œ
- âŒ ä»£ç å¤æ‚ï¼Œéš¾ä»¥ç»´æŠ¤å’Œè°ƒè¯•

### é‡æ„åä¼˜åŠ¿
- âœ… ä¸“ç”¨æœåŠ¡ï¼ŒèŒè´£æ¸…æ™°ï¼ˆæ¯ä¸ª<800è¡Œï¼‰
- âœ… 100%å¤ç°å‚è€ƒè„šæœ¬ï¼ŒåŠŸèƒ½å®Œæ•´
- âœ… æ™ºèƒ½å‚æ•°è®¾è®¡ï¼Œç”¨æˆ·å‹å¥½
- âœ… å®Œå–„é”™è¯¯å¤„ç†ï¼Œç¨³å®šå¯é 
- âœ… æ¨¡å—åŒ–æ¶æ„ï¼Œæ˜“äºæ‰©å±•

## ğŸ“ æ–°ä»£ç è§„èŒƒ

### ä¸“ç”¨æœåŠ¡è§„èŒƒ
```typescript
// âœ… æ­£ç¡®ï¼šLiquidityManagerä¸“æ³¨æµåŠ¨æ€§æ·»åŠ 
export class LiquidityManager implements IService {
    // ä¸»å…¥å£ï¼šæ™ºèƒ½å‚æ•° -> å®Œæ•´æ‰§è¡Œ
    async createLiquidityPosition(params: AddLiquidityParams): Promise<Result> {
        // 100%å¤ç°å‚è€ƒè„šæœ¬æ­¥éª¤
    }
    
    // ç§æœ‰æ–¹æ³•ï¼šåŠŸèƒ½åˆ†è§£
    private async getRealTimeStateAndRecalculate(): Promise<State> {
        // å¤ç° getRealTimeStateAndRecalculate å‡½æ•°
    }
    
    private calculateDynamicSlippage(): number {
        // å¤ç° calculateDynamicSlippage å‡½æ•°  
    }
}
```

### æ™ºèƒ½å‚æ•°è®¾è®¡
```typescript
// âœ… ç”¨æˆ·å‹å¥½çš„å‚æ•°æ¥å£
interface AddLiquidityParams {
    inputAmount: string;        // "0.1" (ç”¨æˆ·å‹å¥½)
    inputToken: 'WBNB' | 'USDT'; // ç®€åŒ–é€‰æ‹©
    lowerPercent: number;       // -5 (ç™¾åˆ†æ¯”)
    upperPercent: number;       // 5 (ç™¾åˆ†æ¯”)  
    baseSlippagePercent: number; // 1 (ç™¾åˆ†æ¯”)
}

// âŒ é¿å…å¤æ‚å‚æ•°
interface OldParams {
    amount0Desired: string;     // éœ€è¦ç”¨æˆ·è®¡ç®—
    amount1Desired: string;     // å¤æ‚è½¬æ¢
    tickLower: number;          // éœ€è¦tickçŸ¥è¯†
    tickUpper: number;          // ä¸å¤Ÿæ™ºèƒ½
}
```

### æ–¹æ³•å¤§å°é™åˆ¶
```typescript
// âœ… æ­£ç¡®ï¼šæ–¹æ³•åˆ†è§£ï¼ˆ<100è¡Œï¼‰
async createLiquidityPosition(params: AddLiquidityParams): Promise<Result> {
    const poolAddress = await this.getPoolAddress();
    const state = await this.getRealTimeState(params);
    const slippage = this.calculateDynamicSlippage(state);
    return await this.executeTransaction(state, slippage);
}

// ç§æœ‰æ–¹æ³•ï¼šåŠŸèƒ½åˆ†è§£
private async getRealTimeState(params: AddLiquidityParams): Promise<State> {
    // ä¸“æ³¨çŠ¶æ€è®¡ç®—ï¼ˆ<100è¡Œï¼‰
}
```

## ğŸš€ æ–°åŠŸèƒ½å®ç°è§„èŒƒ

### æµåŠ¨æ€§æ·»åŠ æµç¨‹
1. **LiquidityManager.createLiquidityPosition()** - ä¸»å…¥å£
2. **getRealTimeStateAndRecalculate()** - å®æ—¶çŠ¶æ€è®¡ç®—
3. **calculateDynamicSlippage()** - åŠ¨æ€æ»‘ç‚¹è®¡ç®—
4. **executeWithRealTimeRecalculation()** - å®Œæ•´æ‰§è¡Œ

### å¤´å¯¸ç®¡ç†æµç¨‹
1. **PositionManager.getUserPositions()** - è·å–æ‰€æœ‰å¤´å¯¸
2. **PositionManager.closeSinglePosition()** - å…³é—­å•ä¸ªå¤´å¯¸
3. **PositionManager.closeAllPositions()** - æ‰¹é‡å…³é—­

### APIè°ƒç”¨æµç¨‹
```
routes.ts -> LiquidityManager -> ContractService -> Web3Service
         -> PositionManager  -> ContractService -> Web3Service
```

## ğŸ›¡ï¸ æ–°æ¶æ„ä¿æŠ¤è§„åˆ™

### å¼ºåˆ¶è¦æ±‚
1. **âœ… LiquidityManageråªå¤„ç†æµåŠ¨æ€§æ·»åŠ **
2. **âœ… PositionManageråªå¤„ç†å¤´å¯¸ç®¡ç†**
3. **âœ… ContractServiceåªæä¾›åŸºç¡€åˆçº¦äº¤äº’**
4. **âœ… å¿…é¡»100%å¤ç°å‚è€ƒè„šæœ¬åŠŸèƒ½å’Œæ­¥éª¤**
5. **âœ… ä½¿ç”¨æ™ºèƒ½å‚æ•°ï¼Œç”¨æˆ·å‹å¥½è®¾è®¡**

### ç¦æ­¢äº‹é¡¹
1. **âŒ LiquidityManageråŒ…å«å¤´å¯¸ç®¡ç†åŠŸèƒ½**
2. **âŒ PositionManageråŒ…å«æµåŠ¨æ€§æ·»åŠ åŠŸèƒ½**
3. **âŒ ContractServiceåŒ…å«å¤æ‚ä¸šåŠ¡é€»è¾‘**
4. **âŒ åˆ é™¤æˆ–ç®€åŒ–å‚è€ƒè„šæœ¬çš„ä»»ä½•æ­¥éª¤**
5. **âŒ å•ä¸€æ–‡ä»¶è¶…è¿‡800è¡Œ**

### é‡æ„æŒ‡å¯¼åŸåˆ™
- **ä¸“ç”¨åŒ–ä¼˜å…ˆ**ï¼šæ¯ä¸ªæœåŠ¡ä¸“æ³¨å•ä¸€åŠŸèƒ½
- **å®Œæ•´å¤ç°**ï¼šå‚è€ƒè„šæœ¬çš„æ‰€æœ‰æ­¥éª¤éƒ½å¿…é¡»ä¿ç•™
- **ç”¨æˆ·å‹å¥½**ï¼šå‚æ•°è®¾è®¡è¦ç®€åŒ–ç”¨æˆ·è¾“å…¥
- **é”™è¯¯å¤„ç†**ï¼šæ¯ä¸ªæ­¥éª¤éƒ½è¦æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†

## ğŸ“Š æ–°æ¶æ„è´¨é‡æŒ‡æ ‡

- **æ–‡ä»¶å¤§å°**ï¼š< 2000è¡Œï¼ˆä¸“ç”¨æœåŠ¡ï¼‰
- **æ–¹æ³•å¤§å°**ï¼š< 200è¡Œ
- **åŠŸèƒ½å¤ç°ç‡**ï¼š100%ï¼ˆå‚è€ƒè„šæœ¬ï¼‰
- **å‚æ•°å‹å¥½åº¦**ï¼šç”¨æˆ·åªéœ€æä¾›ç®€å•å‚æ•°
- **é”™è¯¯å¤„ç†è¦†ç›–ç‡**ï¼š> 95%

## ğŸ”„ è¿ç§»å’Œç»´æŠ¤

### ä»æ—§æ¶æ„è¿ç§»
1. **åŠŸèƒ½åˆ†ç¦»**ï¼šå°†åºå¤§çš„ContractServiceæ‹†åˆ†
2. **ä¸“ç”¨å®ç°**ï¼šLiquidityManagerå’ŒPositionManagerç‹¬ç«‹å®ç°
3. **APIæ›´æ–°**ï¼šroutes.tsè°ƒç”¨æ–°çš„ä¸“ç”¨æœåŠ¡
4. **å‚æ•°ç®€åŒ–**ï¼šä½¿ç”¨æ™ºèƒ½å‚æ•°æ›¿ä»£å¤æ‚å‚æ•°

### æ—¥å¸¸ç»´æŠ¤è§„åˆ™
- æ–°åŠŸèƒ½å¿…é¡»æ”¾åœ¨æ­£ç¡®çš„ä¸“ç”¨æœåŠ¡ä¸­
- ä¸å…è®¸è·¨æœåŠ¡å®ç°ç›¸åŒåŠŸèƒ½
- å®šæœŸæ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œè¶…è¿‡2000è¡Œå¿…é¡»æ‹†åˆ†
- æ‰€æœ‰ä¿®æ”¹å¿…é¡»ä¿æŒ100%åŠŸèƒ½å¤ç°

è¿™ä¸ªæ–°æ¶æ„ç¡®ä¿äº†ä»£ç çš„**ä¸“ä¸šæ€§**ã€**å¯ç»´æŠ¤æ€§**å’Œ**ç”¨æˆ·å‹å¥½æ€§**ï¼ŒåŒæ—¶100%ä¿è¯äº†åŠŸèƒ½çš„å®Œæ•´æ€§å’Œæ­£ç¡®æ€§ã€‚
