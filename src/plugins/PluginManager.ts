import { EventEmitter } from './EventEmitter.js';
import { ProfitLossPlugin } from './ProfitLossPlugin.js';

/**
 * ğŸ›ï¸ æ’ä»¶æ¥å£
 */
export interface IPlugin {
  åç§°: string;
  ç‰ˆæœ¬?: string;
  å¯åŠ¨(): void;
  åœæ­¢(): void;
  å¤„ç†äº‹ä»¶?(äº‹ä»¶å: string, äº‹ä»¶æ•°æ®: any): void;
}

/**
 * ğŸ”§ æ’ä»¶ç®¡ç†å™¨
 * ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸå’Œäº‹ä»¶åˆ†å‘
 */
export class PluginManager extends EventEmitter {
  private static instance: PluginManager;
  private å·²æ³¨å†Œæ’ä»¶: Map<string, IPlugin> = new Map();
  private å·²å¯åŠ¨æ’ä»¶: Set<string> = new Set();
  private äº‹ä»¶æ˜ å°„: Map<string, string[]> = new Map();

  private constructor() {
    super();
    this.åˆå§‹åŒ–äº‹ä»¶æ˜ å°„();
  }

  /**
   * ğŸ—ï¸ è·å–å•ä¾‹å®ä¾‹
   */
  static getInstance(): PluginManager {
    if (!PluginManager.instance) {
      PluginManager.instance = new PluginManager();
    }
    return PluginManager.instance;
  }

  /**
   * ğŸ¯ åˆå§‹åŒ–äº‹ä»¶æ˜ å°„
   */
  private åˆå§‹åŒ–äº‹ä»¶æ˜ å°„(): void {
    // å®šä¹‰äº‹ä»¶åˆ°æ’ä»¶æ–¹æ³•çš„æ˜ å°„
    this.äº‹ä»¶æ˜ å°„.set('strategy.started', ['å¤„ç†ç­–ç•¥å¼€å§‹']);
    this.äº‹ä»¶æ˜ å°„.set('position.created', ['å¤„ç†å¤´å¯¸åˆ›å»º']);
    this.äº‹ä»¶æ˜ å°„.set('swap.executed', ['å¤„ç†ä»£å¸äº¤æ¢']);
    this.äº‹ä»¶æ˜ å°„.set('strategy.ended', ['å¤„ç†ç­–ç•¥ç»“æŸ']);
    this.äº‹ä»¶æ˜ å°„.set('position.closed', ['å¤„ç†å¤´å¯¸å…³é—­']);
  }

  /**
   * ğŸ“ æ³¨å†Œæ’ä»¶
   */
  æ³¨å†Œæ’ä»¶(æ’ä»¶å: string, æ’ä»¶å®ä¾‹: IPlugin): void {
    if (this.å·²æ³¨å†Œæ’ä»¶.has(æ’ä»¶å)) {
      console.warn(`[PLUGIN] æ’ä»¶ ${æ’ä»¶å} å·²å­˜åœ¨ï¼Œå°†è¦†ç›–ç°æœ‰æ’ä»¶`);
      this.åœæ­¢æ’ä»¶(æ’ä»¶å);
    }

    this.å·²æ³¨å†Œæ’ä»¶.set(æ’ä»¶å, æ’ä»¶å®ä¾‹);
    console.log(`[PLUGIN] æ’ä»¶ ${æ’ä»¶å} æ³¨å†ŒæˆåŠŸ`);
  }

  /**
   * ğŸ—‘ï¸ æ³¨é”€æ’ä»¶
   */
  æ³¨é”€æ’ä»¶(æ’ä»¶å: string): boolean {
    if (this.å·²æ³¨å†Œæ’ä»¶.has(æ’ä»¶å)) {
      this.åœæ­¢æ’ä»¶(æ’ä»¶å);
      this.å·²æ³¨å†Œæ’ä»¶.delete(æ’ä»¶å);
      console.log(`[PLUGIN] æ’ä»¶ ${æ’ä»¶å} æ³¨é”€æˆåŠŸ`);
      return true;
    }
    return false;
  }

  /**
   * ğŸš€ å¯åŠ¨æ’ä»¶
   */
  å¯åŠ¨æ’ä»¶(æ’ä»¶å: string): boolean {
    const æ’ä»¶ = this.å·²æ³¨å†Œæ’ä»¶.get(æ’ä»¶å);
    if (æ’ä»¶ && !this.å·²å¯åŠ¨æ’ä»¶.has(æ’ä»¶å)) {
      try {
        æ’ä»¶.å¯åŠ¨();
        this.å·²å¯åŠ¨æ’ä»¶.add(æ’ä»¶å);
        console.log(`[PLUGIN] æ’ä»¶ ${æ’ä»¶å} å¯åŠ¨æˆåŠŸ`);
        return true;
      } catch (error) {
        console.error(`[PLUGIN] æ’ä»¶ ${æ’ä»¶å} å¯åŠ¨å¤±è´¥:`, error);
      }
    }
    return false;
  }

  /**
   * â¹ï¸ åœæ­¢æ’ä»¶
   */
  åœæ­¢æ’ä»¶(æ’ä»¶å: string): boolean {
    const æ’ä»¶ = this.å·²æ³¨å†Œæ’ä»¶.get(æ’ä»¶å);
    if (æ’ä»¶ && this.å·²å¯åŠ¨æ’ä»¶.has(æ’ä»¶å)) {
      try {
        æ’ä»¶.åœæ­¢();
        this.å·²å¯åŠ¨æ’ä»¶.delete(æ’ä»¶å);
        console.log(`[PLUGIN] æ’ä»¶ ${æ’ä»¶å} åœæ­¢æˆåŠŸ`);
        return true;
      } catch (error) {
        console.error(`[PLUGIN] æ’ä»¶ ${æ’ä»¶å} åœæ­¢å¤±è´¥:`, error);
      }
    }
    return false;
  }

  /**
   * ğŸ¯ å¯åŠ¨æ‰€æœ‰æ’ä»¶
   */
  å¯åŠ¨æ‰€æœ‰æ’ä»¶(): void {
    for (const æ’ä»¶å of this.å·²æ³¨å†Œæ’ä»¶.keys()) {
      this.å¯åŠ¨æ’ä»¶(æ’ä»¶å);
    }
  }

  /**
   * â¹ï¸ åœæ­¢æ‰€æœ‰æ’ä»¶
   */
  åœæ­¢æ‰€æœ‰æ’ä»¶(): void {
    for (const æ’ä»¶å of this.å·²å¯åŠ¨æ’ä»¶) {
      this.åœæ­¢æ’ä»¶(æ’ä»¶å);
    }
  }

  /**
   * ğŸ“¡ åˆ†å‘äº‹ä»¶åˆ°æ’ä»¶
   */
  åˆ†å‘äº‹ä»¶(äº‹ä»¶å: string, äº‹ä»¶æ•°æ®: any): void {
    console.log(`[PLUGIN] ğŸ“¡ æ”¶åˆ°äº‹ä»¶åˆ†å‘è¯·æ±‚: ${äº‹ä»¶å}`);
    console.log(`[PLUGIN] ğŸ“Š å½“å‰å·²æ³¨å†Œæ’ä»¶: ${Array.from(this.å·²æ³¨å†Œæ’ä»¶.keys()).join(', ')}`);
    console.log(`[PLUGIN] ğŸ“Š å½“å‰å·²å¯åŠ¨æ’ä»¶: ${Array.from(this.å·²å¯åŠ¨æ’ä»¶).join(', ')}`);
    
    const ç›®æ ‡æ–¹æ³•åˆ—è¡¨ = this.äº‹ä»¶æ˜ å°„.get(äº‹ä»¶å);
    console.log(`[PLUGIN] ğŸ¯ äº‹ä»¶ ${äº‹ä»¶å} å¯¹åº”çš„ç›®æ ‡æ–¹æ³•: ${ç›®æ ‡æ–¹æ³•åˆ—è¡¨?.join(', ') || 'æ— æ˜ å°„'}`);
    
    if (!ç›®æ ‡æ–¹æ³•åˆ—è¡¨) {
      console.log(`[PLUGIN] âš ï¸ äº‹ä»¶ ${äº‹ä»¶å} æ²¡æœ‰æ˜ å°„çš„å¤„ç†æ–¹æ³•ï¼Œé™é»˜å¿½ç•¥`);
      return; // æ²¡æœ‰æ˜ å°„çš„äº‹ä»¶ï¼Œé™é»˜å¿½ç•¥
    }

    for (const [æ’ä»¶å, æ’ä»¶å®ä¾‹] of this.å·²æ³¨å†Œæ’ä»¶) {
      console.log(`[PLUGIN] ğŸ” æ£€æŸ¥æ’ä»¶: ${æ’ä»¶å}, æ˜¯å¦å·²å¯åŠ¨: ${this.å·²å¯åŠ¨æ’ä»¶.has(æ’ä»¶å)}`);
      
      if (this.å·²å¯åŠ¨æ’ä»¶.has(æ’ä»¶å)) {
        for (const æ–¹æ³•å of ç›®æ ‡æ–¹æ³•åˆ—è¡¨) {
          try {
            const æ–¹æ³• = (æ’ä»¶å®ä¾‹ as any)[æ–¹æ³•å];
            console.log(`[PLUGIN] ğŸ¯ åœ¨æ’ä»¶ ${æ’ä»¶å} ä¸­æŸ¥æ‰¾æ–¹æ³• ${æ–¹æ³•å}, æ‰¾åˆ°: ${typeof æ–¹æ³• === 'function' ? 'æ˜¯' : 'å¦'}`);
            
            if (typeof æ–¹æ³• === 'function') {
              console.log(`[PLUGIN] ğŸš€ è°ƒç”¨æ’ä»¶ ${æ’ä»¶å} çš„æ–¹æ³• ${æ–¹æ³•å}`);
              æ–¹æ³•.call(æ’ä»¶å®ä¾‹, äº‹ä»¶æ•°æ®);
              console.log(`[PLUGIN] âœ… æ’ä»¶ ${æ’ä»¶å} çš„æ–¹æ³• ${æ–¹æ³•å} è°ƒç”¨æˆåŠŸ`);
            }
          } catch (error) {
            console.error(`[PLUGIN] âŒ æ’ä»¶ ${æ’ä»¶å} å¤„ç†äº‹ä»¶ ${äº‹ä»¶å} å¤±è´¥:`, error);
          }
        }
      }
    }

    // å‘å°„ç®¡ç†å™¨çº§åˆ«çš„äº‹ä»¶ï¼ˆä¾›å…¶ä»–ç»„ä»¶ç›‘å¬ï¼‰
    this.emit(äº‹ä»¶å, äº‹ä»¶æ•°æ®);
  }

  /**
   * ğŸ“‹ è·å–æ’ä»¶çŠ¶æ€
   */
  è·å–æ’ä»¶çŠ¶æ€(): { [æ’ä»¶å: string]: { å·²æ³¨å†Œ: boolean; å·²å¯åŠ¨: boolean; ç‰ˆæœ¬?: string } } {
    const çŠ¶æ€: any = {};
    
    for (const [æ’ä»¶å, æ’ä»¶å®ä¾‹] of this.å·²æ³¨å†Œæ’ä»¶) {
      çŠ¶æ€[æ’ä»¶å] = {
        å·²æ³¨å†Œ: true,
        å·²å¯åŠ¨: this.å·²å¯åŠ¨æ’ä»¶.has(æ’ä»¶å),
        ç‰ˆæœ¬: æ’ä»¶å®ä¾‹.ç‰ˆæœ¬ || 'æœªçŸ¥'
      };
    }

    return çŠ¶æ€;
  }

  /**
   * ğŸ” è·å–æ’ä»¶å®ä¾‹
   */
  è·å–æ’ä»¶<T = IPlugin>(æ’ä»¶å: string): T | undefined {
    return this.å·²æ³¨å†Œæ’ä»¶.get(æ’ä»¶å) as T;
  }

  /**
   * ğŸ“Š è·å–è¿è¡Œç»Ÿè®¡
   */
  è·å–è¿è¡Œç»Ÿè®¡(): {
    æ€»æ’ä»¶æ•°: number;
    è¿è¡Œä¸­æ’ä»¶æ•°: number;
    äº‹ä»¶æ˜ å°„æ•°: number;
    å·²æ³¨å†Œæ’ä»¶åˆ—è¡¨: string[];
    è¿è¡Œä¸­æ’ä»¶åˆ—è¡¨: string[];
  } {
    return {
      æ€»æ’ä»¶æ•°: this.å·²æ³¨å†Œæ’ä»¶.size,
      è¿è¡Œä¸­æ’ä»¶æ•°: this.å·²å¯åŠ¨æ’ä»¶.size,
      äº‹ä»¶æ˜ å°„æ•°: this.äº‹ä»¶æ˜ å°„.size,
      å·²æ³¨å†Œæ’ä»¶åˆ—è¡¨: Array.from(this.å·²æ³¨å†Œæ’ä»¶.keys()),
      è¿è¡Œä¸­æ’ä»¶åˆ—è¡¨: Array.from(this.å·²å¯åŠ¨æ’ä»¶)
    };
  }

  /**
   * ğŸ›ï¸ åˆå§‹åŒ–é»˜è®¤æ’ä»¶
   */
  åˆå§‹åŒ–é»˜è®¤æ’ä»¶(): void {
    // æ³¨å†Œç›ˆäºç»Ÿè®¡æ’ä»¶
    const ç›ˆäºæ’ä»¶ = new ProfitLossPlugin();
    // å°†æ’ä»¶å®ä¾‹é€‚é…ä¸ºIPluginæ¥å£
    const é€‚é…æ’ä»¶: IPlugin = {
      åç§°: 'ç›ˆäºç»Ÿè®¡æ’ä»¶',
      ç‰ˆæœ¬: '1.0.0',
      å¯åŠ¨: () => ç›ˆäºæ’ä»¶.å¯åŠ¨(),
      åœæ­¢: () => ç›ˆäºæ’ä»¶.åœæ­¢(),
      å¤„ç†ç­–ç•¥å¼€å§‹: (äº‹ä»¶æ•°æ®: any) => ç›ˆäºæ’ä»¶.å¤„ç†ç­–ç•¥å¼€å§‹(äº‹ä»¶æ•°æ®),
      å¤„ç†å¤´å¯¸åˆ›å»º: (äº‹ä»¶æ•°æ®: any) => ç›ˆäºæ’ä»¶.å¤„ç†å¤´å¯¸åˆ›å»º(äº‹ä»¶æ•°æ®),
      å¤„ç†ä»£å¸äº¤æ¢: (äº‹ä»¶æ•°æ®: any) => ç›ˆäºæ’ä»¶.å¤„ç†ä»£å¸äº¤æ¢(äº‹ä»¶æ•°æ®),
      å¤„ç†ç­–ç•¥ç»“æŸ: (äº‹ä»¶æ•°æ®: any) => ç›ˆäºæ’ä»¶.å¤„ç†ç­–ç•¥ç»“æŸ(äº‹ä»¶æ•°æ®),
      å¤„ç†å¤´å¯¸å…³é—­: (äº‹ä»¶æ•°æ®: any) => ç›ˆäºæ’ä»¶.å¤„ç†å¤´å¯¸å…³é—­(äº‹ä»¶æ•°æ®)
    } as any;

    this.æ³¨å†Œæ’ä»¶('profit-loss', é€‚é…æ’ä»¶);
    this.å¯åŠ¨æ’ä»¶('profit-loss');

    // å°†ç›ˆäºæ’ä»¶å®ä¾‹ä¿å­˜åˆ°ç®¡ç†å™¨ï¼Œæ–¹ä¾¿å¤–éƒ¨è®¿é—®
    (this as any).ç›ˆäºæ’ä»¶ = ç›ˆäºæ’ä»¶;

    console.log('[PLUGIN] é»˜è®¤æ’ä»¶åˆå§‹åŒ–å®Œæˆ');
  }

  /**
   * ğŸ¯ è·å–ç›ˆäºæ’ä»¶å®ä¾‹
   */
  è·å–ç›ˆäºæ’ä»¶(): ProfitLossPlugin | undefined {
    return (this as any).ç›ˆäºæ’ä»¶;
  }
}

// å¯¼å‡ºå…¨å±€æ’ä»¶ç®¡ç†å™¨å®ä¾‹
export const æ’ä»¶ç®¡ç†å™¨ = PluginManager.getInstance(); 